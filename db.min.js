(function(e,t){"use strict";var n=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,r=e.IDBKeyRange||e.webkitIDBKeyRange,i={readonly:"readonly",readwrite:"readwrite"};var s=Object.prototype.hasOwnProperty;if(!n){throw"IndexedDB required"}var o=function(e){return e};var u=function(){var e,t=[];var n=function(n,r){if(t){r=r||[];e=e||[n,r];for(var i=0,s=t.length;i<s;i++){t[i].apply(e[0],e[1])}t=[]}};this.add=function(){for(var r=0,i=arguments.length;r<i;r++){t.push(arguments[r])}if(e){n()}return this};this.execute=function(){n(this,arguments);return this}};var a=function(e){var t="progress",n=[["resolve","done",new u,"resolved"],["reject","fail",new u,"rejected"],["notify","progress",new u]],r={},i={state:function(){return t},then:function(){var e=arguments;return a(function(t){n.forEach(function(n,i){var s=e[i];r[n[1]](typeof s==="function"?function(){var e=s.apply(this,arguments);if(e&&typeof e.promise==="function"){e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}}:t[n[0]])})}).promise()},promise:function(e){if(e){Object.keys(i).forEach(function(t){e[t]=i[t]});return e}return i}};n.forEach(function(e,n){var s=e[2],o=e[3];i[e[1]]=s.add;if(o){s.add(function(){t=o})}r[e[0]]=s.execute});i.promise(r);if(e){e.call(r,r)}return r};var f=function(e,t){var n=this,r=false;this.add=function(t){if(r){throw"Database has been closed"}var s=[];for(var o=0;o<arguments.length-1;o++){s[o]=arguments[o+1]}var u=e.transaction(t,i.readwrite),f=u.objectStore(t),l=a();s.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item;t=f.add(e,n)}else{t=f.add(e)}t.onsuccess=function(t){var n=t.target;var r=n.source.keyPath;if(r===null){r="__id__"}Object.defineProperty(e,r,{value:n.result,enumerable:true});l.notify()}});u.oncomplete=function(){l.resolve(s,n)};u.onerror=function(e){l.reject(s,e)};u.onabort=function(e){l.reject(s,e)};return l.promise()};this.update=function(t){if(r){throw"Database has been closed"}var s=[];for(var o=0;o<arguments.length-1;o++){s[o]=arguments[o+1]}var u=e.transaction(t,i.readwrite),f=u.objectStore(t),l=f.keyPath,c=a();s.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item;t=f.put(e,n)}else{t=f.put(e)}t.onsuccess=function(e){c.notify()}});u.oncomplete=function(){c.resolve(s,n)};u.onerror=function(e){c.reject(s,e)};u.onabort=function(e){c.reject(s,e)};return c.promise()};this.remove=function(t,n){if(r){throw"Database has been closed"}var s=e.transaction(t,i.readwrite),o=s.objectStore(t),u=a();var f=o.delete(n);s.oncomplete=function(){u.resolve(n)};s.onerror=function(e){u.reject(e)};return u.promise()};this.clear=function(t){if(r){throw"Database has been closed"}var n=e.transaction(t,i.readwrite),s=n.objectStore(t),o=a();var u=s.clear();n.oncomplete=function(){o.resolve()};n.onerror=function(e){o.reject(e)};return o.promise()};this.close=function(){if(r){throw"Database has been closed"}e.close();r=true;delete p[t]};this.get=function(t,n){if(r){throw"Database has been closed"}var i=e.transaction(t),s=i.objectStore(t),o=a();var u=s.get(n);u.onsuccess=function(e){o.resolve(e.target.result)};i.onerror=function(e){o.reject(e)};return o.promise()};this.query=function(t,n){if(r){throw"Database has been closed"}return new l(t,e,n)};for(var o=0,u=e.objectStoreNames.length;o<u;o++){(function(e){n[e]={};for(var t in n){if(!s.call(n,t)||t==="close"){continue}n[e][t]=function(t){return function(){var r=[e].concat([].slice.call(arguments,0));return n[t].apply(n,r)}}(t)}})(e.objectStoreNames[o])}};var l=function(e,n,s){var u=this;var f=false;var l=function(o,u,l,c,h,p,d){var v=n.transaction(e,f?i.readwrite:i.readonly),m=v.objectStore(e),g=s?m.index(s):m,y=o?r[o].apply(null,u):null,b=[],w=a(),E=[y],h=h?h:null,p=p?p:[],S=0;if(l!=="count"){E.push(c||"next")}var x=f?Object.keys(f):false;var T=function(e){for(var t=0;t<x.length;t++){var n=x[t];var r=f[n];if(r instanceof Function)r=r(e);e[n]=r}return e};g[l].apply(g,E).onsuccess=function(e){var n=e.target.result;if(typeof n===typeof 0){b=n}else if(n){if(h!==null&&h[0]>S){S=h[0];n.advance(h[0])}else if(h!==null&&S>=h[0]+h[1]){}else{var r=true;var i="value"in n?n.value:n.key;p.forEach(function(e){if(!e||!e.length){}else if(e.length===2){r=i[e[0]]===e[1]}else{r=e[0].apply(t,[i])}});if(r){S++;b.push(d(i));if(f){i=T(i);n.update(i)}}n.continue()}}};v.oncomplete=function(){w.resolve(b)};v.onerror=function(e){w.reject(e)};v.onabort=function(e){w.reject(e)};return w.promise()};var c=function(e,t){var n="next",r="openCursor",i=[],s=null,u=o,a=false;var c=function(){return l(e,t,r,a?n+"unique":n,s,i,u)};var h=function(){s=Array.prototype.slice.call(arguments,0,2);if(s.length==1){s.unshift(0)}return{execute:c}};var p=function(){n=null;r="count";return{execute:c}};var d=function(){r="openKeyCursor";return{desc:m,execute:c,filter:v,distinct:g,map:b}};var v=function(){i.push(Array.prototype.slice.call(arguments,0,2));return{keys:d,execute:c,filter:v,desc:m,distinct:g,modify:y,limit:h,map:b}};var m=function(){n="prev";return{keys:d,execute:c,filter:v,distinct:g,modify:y,map:b}};var g=function(){a=true;return{keys:d,count:p,execute:c,filter:v,desc:m,modify:y,map:b}};var y=function(e){f=e;return{execute:c}};var b=function(e){u=e;return{execute:c,count:p,keys:d,filter:v,desc:m,distinct:g,modify:y,limit:h,map:b}};return{execute:c,count:p,keys:d,filter:v,desc:m,distinct:g,modify:y,limit:h,map:b}};"only bound upperBound lowerBound".split(" ").forEach(function(e){u[e]=function(){return new c(e,arguments)}});this.filter=function(){var e=new c(null,null);return e.filter.apply(e,arguments)};this.all=function(){return this.filter()}};var c=function(e,t,n){if(typeof t==="function"){t=t()}for(var r in t){var i=t[r];var o;if(!s.call(t,r)||n.objectStoreNames.contains(r)){o=e.currentTarget.transaction.objectStore(r)}else{o=n.createObjectStore(r,i.key)}for(var u in i.indexes){var a=i.indexes[u];o.createIndex(u,a.key||u,Object.keys(a).length?a:{unique:false})}}};var h=function(e,t,n,r){var i=e.target.result;var s=new f(i,t);var o;var u=a();u.resolve(s);p[t]=i;return u.promise()};var p={};var d={version:"0.9.0",open:function(e){var t;var r=a();if(p[e.server]){h({target:{result:p[e.server]}},e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify)}else{t=n.open(e.server,e.version);t.onsuccess=function(t){h(t,e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify)};t.onupgradeneeded=function(t){c(t,e.schema,t.target.result)};t.onerror=function(e){r.reject(e)}}return r.promise()}};if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=d}else if(typeof define==="function"&&define.amd){define(function(){return d})}else{e.db=d}})(window)